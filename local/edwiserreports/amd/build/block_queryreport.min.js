define(["jquery","local_edwiserreports/defaultconfig","core/templates","local_edwiserreports/select2"],(function(e,t,n){e(document).ready((function(){var s='<span class="px-10 py-5 pull-right"><i class="fa fa-spinner fa-spin"></i></span>';e("#ed_rpm").select2({multiple:!0,closeOnSelect:!1,placeholder:"Reporting Managers"}),e("#ed_lps").select2({multiple:!0,closeOnSelect:!1,placeholder:"Learning Programs"}),e("#ed_courses").select2({multiple:!0,closeOnSelect:!1,placeholder:"Courses"}),e("#ed_cohorts").select2({multiple:!0,closeOnSelect:!1,placeholder:"Cohorts"}),e("#ed_users").select2({multiple:!0,closeOnSelect:!1,placeholder:"Users"}),e("#ed_activitytype").select2({maximumSelectionLength:1,multiple:!0,closeOnSelect:!0,placeholder:"Activity Type"}),selectedLps=["0"],e("#ed_lps").on("change",(function(l){e("div[class^='lp']").show();var o=[];if(e(l.currentTarget).find("option:selected").each((function(t,n){o[t]=e(n).val()})),JSON.stringify(selectedLps)!==JSON.stringify(o)){switch(e("#ed_courses").html("").siblings(".select2-container").find(".select2-selection").html(s),oldIndex=selectedLps.indexOf("0"),newIndex=o.indexOf("0"),!0){case-1==oldIndex&&newIndex>-1:o=["0"],selectedLps=o,e("#ed_lps").select2("val",o);break;case oldIndex>-1&&newIndex>-1:o.splice(newIndex,1),selectedLps=o,e("#ed_lps").select2("val",o)}selectedLps=o,e.ajax({url:t.requestUrl,type:t.requestType,dataType:t.requestDataType,data:{action:"get_customqueryreport_data_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({lpids:o})}}).done((function(t){e("#ed_courses").html("");var s={courses:t};n.render("local_edwiserreports/customquery_options",s).then((function(t,s){n.replaceNodeContents(e("#ed_courses"),t,s)}))})).fail((function(e){console.log(e)})).always((function(){e("#ed_courses").select2({multiple:!0,closeOnSelect:!1,placeholder:"Courses"})})),o.length||e("div[class^='lp']").hide()}})),selectedRPM=["0"],e("#ed_rpm").on("change",(function(l){var o=[];e(l.currentTarget).find("option:selected").each((function(t,n){o[t]=e(n).val()}));var c=[];if(e("#ed_cohorts").find("option:selected").each((function(t,n){c[t]=e(n).val()})),JSON.stringify(selectedRPM)!==JSON.stringify(o)){switch(e("div[class^='rpm']").show(),e("#ed_lps").html("").siblings(".select2-container").find(".select2-selection").html(s),e("#ed_courses").html("").siblings(".select2-container").find(".select2-selection").html(s),e("#ed_users").html("").siblings(".select2-container").find(".select2-selection").html(s),oldIndex=selectedRPM.indexOf("0"),newIndex=o.indexOf("0"),!0){case-1==oldIndex&&newIndex>-1:o=["0"],selectedRPM=o,e("#ed_rpm").select2("val",o);break;case oldIndex>-1&&newIndex>-1:o.splice(newIndex,1),selectedRPM=o,e("#ed_rpm").select2("val",o)}selectedRPM=o,e.ajax({url:t.requestUrl,type:t.requestType,dataType:t.requestDataType,data:{action:"get_customqueryreport_rpm_data_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({rpmids:o,cohortids:c})}}).done((function(t){e("#ed_lps").html(""),e("#ed_courses").html("");var s="local_edwiserreports/customquery_lpoptions",l={lps:t.lps};if(t.lps.length>0&&n.render(s,l).then((function(t,s){n.appendNodeContents(e("#ed_lps"),t,s)})),t.courses.length>0){s="local_edwiserreports/customquery_options",l={courses:t.courses};n.render(s,l).then((function(t,s){n.appendNodeContents(e("#ed_courses"),t,s)}))}if(t.users.length>0){s="local_edwiserreports/customquery_lpoptions",l={lps:t.users};t.users.length>0&&n.render(s,l).then((function(t,s){n.appendNodeContents(e("#ed_users"),t,s)}))}})).fail((function(e){console.log(e)})).always((function(){e("#ed_lps").select2({multiple:!0,closeOnSelect:!1,placeholder:"Learning Programs"}),e("#ed_courses").select2({multiple:!0,closeOnSelect:!1,placeholder:"Courses"}),e("#ed_users").select2({multiple:!0,closeOnSelect:!1,placeholder:"Users"})})),o.length||(e("div[class^='rpm']").hide(),e("div[class^='lp']").hide())}}));var l=["0"];e("#ed_courses").on("change",(function(t){var n=[];if(e(t.currentTarget).find("option:selected").each((function(t,s){n[t]=e(s).val()})),JSON.stringify(l)!==JSON.stringify(n)){switch(oldIndex=l.indexOf("0"),newIndex=n.indexOf("0"),!0){case-1==oldIndex&&newIndex>-1:l=n=["0"],e("#ed_courses").select2("val",n);break;case oldIndex>-1&&newIndex>-1:n.splice(newIndex,1),l=n,e("#ed_courses").select2("val",n)}l=n}}));var o=["0"];e("#ed_cohorts").on("change",(function(l){var c=[];e(l.currentTarget).find("option:selected").each((function(t,n){c[t]=e(n).val()}));var i=[];if(e("#ed_rpm").find("option:selected").each((function(t,n){i[t]=e(n).val()})),JSON.stringify(o)!==JSON.stringify(c)){switch(e("#ed_users").html("").siblings(".select2-container").find(".select2-selection").html(s),oldIndex=o.indexOf("0"),newIndex=c.indexOf("0"),!0){case-1==oldIndex&&newIndex>-1:o=c=["0"],e("#ed_cohorts").select2("val",c);break;case oldIndex>-1&&newIndex>-1:c.splice(newIndex,1),o=c,e("#ed_cohorts").select2("val",c)}o=c,e.ajax({url:t.requestUrl,type:t.requestType,dataType:t.requestDataType,data:{action:"get_customqueryreport_cohort_users_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({cohortids:c,rpmids:i})}}).done((function(t){var s={lps:t.users};t.users.length>0&&n.render("local_edwiserreports/customquery_lpoptions",s).then((function(t,s){n.appendNodeContents(e("#ed_users"),t,s)}))})).fail((function(e){console.log(e)})).always((function(){e("#ed_users").select2({multiple:!0,closeOnSelect:!1,placeholder:"Users"})}))}}));var c=["-1"];e("#ed_users").on("change",(function(t){var n=[];if(e(t.currentTarget).find("option:selected").each((function(t,s){n[t]=e(s).val()})),JSON.stringify(c)!==JSON.stringify(n)){switch(oldIndex=c.indexOf("0"),newIndex=n.indexOf("0"),!0){case-1==oldIndex&&newIndex>-1:c=n=["0"],e("#ed_users").select2("val",n);break;case oldIndex>-1&&newIndex>-1:n.splice(newIndex,1),c=n,e("#ed_users").select2("val",n)}c=n}}));var i=t.getPanel("#customQueryReportBlock");let a=e(i).find("#customQueryReportsForm");const d=function(t,n,s,l){e(i).find(t).flatpickr({mode:n,altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",maxDate:l,defaultDate:s,onClose:r,onReady:r})},r=function(t,n,s){const l=t[0].getTime()/1e3;switch(!0){case e(s.element).is("#customqueryenrollstart"):a.find("input[name=enrolstartdate]").val(l);break;case e(s.element).is("#customqueryenrollend"):a.find("input[name=enrolenddate]").val(l);break;case e(s.element).is("#customquerycompletionstart"):a.find("input[name=completionstartdate]").val(l);break;case e(s.element).is("#customquerycompletionend"):a.find("input[name=completionenddate]").val(l)}};function u(t){const n=jQuery("#ed_courses > option:selected").length,s=a.serializeArray(),l={};var o;e.each(s,(function(e,t){l[t.name]=t.value})),n<1?(e(".coursealert").show(),setTimeout((function(){e(".coursealert").hide()}),3e3),t.preventDefault()):l.enrolstartdate>l.enrolenddate||""==l.enrolstartdate&&""!==l.enrolenddate||""!==l.enrolstartdate&&""==l.enrolenddate?(e(".enroldatealert").show(),setTimeout((function(){e(".enroldatealert").hide()}),3e3),t.preventDefault()):l.completionstartdate>l.completionenddate||""==l.completionstartdate&&""!==l.completionenddate||""!==l.completionstartdate&&""==l.completionenddate?(e(".completiondatealert").show(),setTimeout((function(){e(".completiondatealert").hide()}),3e3),t.preventDefault()):(o=[],e(i).find("input[type=checkbox]:checked").each((function(e,t){o.push(t.id)})),a.find("input[name=reporttype]").val("queryReport"),a.find("input[name=checkedFields]").val(o),function(){var t,n,s,l,o,c;t=e(i).find("#ed_rpm").val(),a.find("input[name=reportingmanagers]").val(t),n=e(i).find("#ed_lps").val(),a.find("input[name=lps]").val(n),s=e(i).find("#ed_courses").val(),a.find("input[name=courses]").val(s),l=e(i).find("#ed_cohorts").val(),a.find("input[name=cohortids]").val(l),o=e(i).find("#ed_users").val(),a.find("input[name=userids]").val(o),c=e(i).find("#ed_activitytype").val(),a.find("input[name=activitytype]").val(c)}())}d("#customqueryenrollstart, #customquerycompletionstart","single",(new Date).setDate((new Date).getDate()-90),"today"),d("#customqueryenrollend, #customquerycompletionend","single","today","today"),e(document).on("click","#customqueryenrollstart ~ button.input-search-close",(function(){e("#customqueryenrollstart ~ input.form-control").val(""),a.find("input[name=enrolstartdate]").val("")})),e(document).on("click","#customqueryenrollend ~ button.input-search-close",(function(){e("#customqueryenrollend ~ input.form-control").val(""),a.find("input[name=enrolenddate]").val("")})),e(document).on("click","#customquerycompletionstart ~ button.input-search-close",(function(){e("#customquerycompletionstart ~ input.form-control").val(""),a.find("input[name=completionenddate]").val("")})),e(document).on("click","#customquerycompletionend ~ button.input-search-close",(function(){e("#customquerycompletionend ~ input.form-control").val(""),a.find("input[name=completionstartdate]").val("")})),e("#customQueryReportDownload").click((function(e){u(e)})),e("[data-hide]").on("click",(function(){e(this).closest("."+e(this).attr("data-hide")).hide()})),e('.reportfields a[class^="unselect-"]').on("click",(function(){e(this).closest(".reportfields").find('input[type="checkbox"]:not(:disabled)').prop("checked",!1),e(this).hide().siblings('a[class^="select-"]').show()})),e('.reportfields a[class^="select-"]').on("click",(function(){e(this).closest(".reportfields").find('input[type="checkbox"]:not(:disabled)').prop("checked",!0),e(this).hide().siblings('a[class^="unselect-"]').show()})),e(i).find(".checkbox-custom").on("click",(function(){e(this).closest(".reportfields").find('input[type="checkbox"]').length==e(this).closest(".reportfields").find('input[type="checkbox"]:checked').length?e(this).closest(".reportfields").find('a[class^="select-"]').hide().siblings('a[class^="unselect-"]').show():e(this).closest(".reportfields").find('a[class^="unselect-"]').hide().siblings('a[class^="select-"]').show()}));e(i).find("#edw_custom_reporttype input[type='radio']").on("change",(function(){"activities"==e(this).val()?(e(i).find("#ed_activitytype").closest(".activitytype.select").show(),e(i).find(".activityreportfields").show(),e(i).find('.activityfields input[type="checkbox"]').attr("checked",!0)):(e(i).find("#ed_activitytype").closest(".activitytype.select").hide(),e(i).find(".activityreportfields").hide(),e(i).find('.activityfields input[type="checkbox"]').removeAttr("checked")),e(a).find('input[name="reportlevel"]').val(e(this).val())}))}))}));
