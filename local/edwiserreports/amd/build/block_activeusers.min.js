define(["jquery","core/chartjs","local_edwiserreports/defaultconfig","local_edwiserreports/variables","./common","local_edwiserreports/flatpickr"],(function(e,o,t,a,r){var l=null,n=null,s=t.getPanel("#activeusersblock"),i=t.getPanel("#activeusersblock","body"),d=t.getPanel("#activeusersblock","title"),c=t.getPanel("#activeusersblock","footer"),p=s+" .dropdown-menu[aria-labelledby='filter-dropdown']:not('custom')",u=p+" .dropdown-item",g=s+" #filter-dropdown.dropdown-toggle",h=s+" #flatpickrCalender",m=i+" .ct-chart",f=i+" .loader",b=s+" button#filter-dropdown",C=d+" .refresh",v=s+a.exportUrlLink,k=null,y=d+" input.form-control.input",w=null;return{init:function(i){function U(a){e(m).hide(),e(f).show(),a||(a="weekly"),r.loader.show("#activeusersblock"),e.ajax({url:t.requestUrl,data:{action:"get_activeusers_graph_data_ajax",sesskey:e(s).data("sesskey"),data:JSON.stringify({filter:a})}}).done((function(e){e=JSON.parse(e),l.graph.data=e.data,l.graph.labels=e.labels})).fail((function(e){console.log(e)})).always((function(){n=function(){n&&n.destroy();return o.defaults.global.defaultFontFamily=l.graph.fontFamily,o.defaults.global.defaultFontStyle=l.graph.fontStyle,n=new o(l.ctx,{type:l.graph.type,data:x(),options:l.graph.options})}(),e(c).find('.download-links input[name="filter"]').val(a),e(d+" #updated-time > span.minute").html(0),setInterval(S,6e4),e(C).removeClass("refresh-spin"),e(f).hide(),e(m).fadeIn("slow"),w("activeUsers"),r.loader.hide("#activeusersblock")}))}function S(){e(d+" #updated-time > span.minute").html(parseInt(e(d+" #updated-time > span.minute").text())+1)}function x(){return{labels:l.graph.labels,datasets:[{label:l.graph.labelName.activeUsers,data:l.graph.data.activeUsers,backgroundColor:l.graph.backgroundColor.activeUsers,borderColor:l.graph.borderColor.activeUsers,pointBorderColor:l.graph.borderColor.activeUsers,pointBackgroundColor:l.graph.borderColor.activeUsers,pointStyle:l.graph.pointStyle},{label:l.graph.labelName.enrolments,data:l.graph.data.enrolments,backgroundColor:l.graph.backgroundColor.enrolments,borderColor:l.graph.borderColor.enrolments,pointBorderColor:l.graph.borderColor.enrolments,pointBackgroundColor:l.graph.borderColor.enrolments,pointStyle:l.graph.pointStyle},{label:l.graph.labelName.completionRate,data:l.graph.data.completionRate,backgroundColor:l.graph.backgroundColor.completionRate,borderColor:l.graph.borderColor.completionRate,pointBorderColor:l.graph.borderColor.completionRate,pointBackgroundColor:l.graph.borderColor.completionRate,pointStyle:l.graph.pointStyle}]}}w=i,e(document).ready((function(){(l=t.getActiveUsersBlock())?(e(g).on("click",(function(){e(p).addClass("show")})),e(y).ready((function(){var o=e(y).attr("placeholder");e(y).val(o)})),e(document).click((function(o){e(o.target).hasClass("dropdown-menu")||e(o.target).parents(".dropdown-menu").length||e(p).removeClass("show")})),e(u+":not(.custom)").on("click",(function(){k=e(this).attr("value"),e(p).removeClass("show"),e(b).html(e(this).text()),U(k),e(h).val("Custom"),e(y).val("Custom")})),e(C).on("click",(function(){e(this).addClass("refresh-spin"),U(k)})),n=U(),e(h).flatpickr({mode:"range",altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:document.getElementById("activeUser-calendar"),onOpen:function(o){e(p).addClass("withcalendar")},onClose:function(){e(p).removeClass("withcalendar"),e(p).removeClass("show"),function(){k=e(h).val();var o=e(y).val();if(!k.includes("to"))return!1;t.changeExportUrl(k,v,a.filterReplaceFlag),e(b).html(o),e(h).val(""),U(k)}()}})):w("activeUsers")}))}}}));
