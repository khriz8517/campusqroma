define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","core/str","local_edwiserreports/variables","local_edwiserreports/selectors","local_edwiserreports/templateselector","local_edwiserreports/jspdf","local_edwiserreports/select2","local_edwiserreports/jquery.dataTables","local_edwiserreports/dataTables.bootstrap4"],(function(e,t,o,a,n,i,r,l,s,d,c){var u=null,f="#scheduletab",p=f+" input#esr-sendtime",m=M.util.get_string("scheduleerrormsg","local_edwiserreports"),g=M.util.get_string("schedulesuccessmsg","local_edwiserreports"),h=M.util.get_string("deletesuccessmsg","local_edwiserreports"),b=M.util.get_string("deleteerrormsg","local_edwiserreports"),v=M.util.get_string("emptyerrormsg","local_edwiserreports"),y=M.util.get_string("emailinvaliderrormsg","local_edwiserreports"),k={show:function(t){var o;null==t?(t="body",o="position-fixed"):o="position-absolute",e(t).append(`\n            <div class="edwiserreports-loader ${o}">\n                <i class="fa fa-circle-o-notch fa-spin" aria-hidden="true"></i>\n            </div>\n            `)},hide:function(t){null==t&&(t="body"),e(t+" > .edwiserreports-loader").remove()}};function w(t){t.modal.find(".comparisontable .switch-capability").on("click",(function(t){var o=e(t.currentTarget).find("input[type=radio]"),a=o.filter(":checked"),n=o.eq(o.index(a)+1);0===n.length&&(n=o.eq(0)),n.prop("checked",!0);var i=n.data("strpermission"),r=n.data("permissionclass");e(t.currentTarget).removeClass("inherit allow prevent prohibit"),e(t.currentTarget).addClass(r),e(t.currentTarget).find("label").html(i)}))}function _(t,o){var a=o.getRoot().find("#esr-shceduled-emails");return e(document).on("click",'[aria-controls="listemailstab"]',(function(){e(window).resize()})),a.DataTable({ajax:{url:l.requestUrl+"?sesskey="+t.sesskey,type:l.requestType,data:{action:"get_scheduled_emails_ajax",data:JSON.stringify({blockname:t.block,region:t.region})}},language:{searchPlaceholder:"Search shceduled email",emptyTable:"There is no scheduled emails",sClass:"text-center"},drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")},order:[[2,"asc"]],columns:[{data:"esrname",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,bInfo:!1,lengthChange:!1})}return e(document).ready((function(){e("#page-admin-report-edwiserReport-index .page-content").width();e(document).on("click",'.download-links button[value="pdf"]',(function(t){t.preventDefault();var o=e(this).closest("form");e.ajax({url:o.attr("action"),type:"POST",data:{type:e(this).val(),block:o.find('input[name="block"]').val(),filter:o.find('input[name="filter"]').val(),cohortid:o.find('input[name="cohortid"]').val(),region:o.find('input[name="region"]').val()}}).done((function(e){e=JSON.parse(e);var t=c("p","pt","a4"),o={top:40,bottom:30,left:10,width:"100%"};t.setFontSize(10);t.fromHTML(e.data.html,o.left,o.top,{width:o.width,elementHandlers:{"#bypassme":function(e,t){return!0}}},(function(o){t.save(e.data.filename)}),o)})).always((function(){e(document).find("#cover-spin").hide()}))})),e(document).on("click",'.download-links button[value="email"]',(function(o){o.preventDefault();var s=l.getScheduledEmailFormContext(),d=e(this).closest("form").serializeArray();e(d).each((function(e,t){s[t.name]=t.value})),a.create({title:M.util.get_string("scheduleemailfor","local_edwiserreports")+" "+M.util.get_string(s.block+"exportheader","local_edwiserreports"),body:i.render("local_edwiserreports/email_schedule_tabs",s)},e(this)).done((function(o){var a=o.getRoot();o.modal.addClass("modal-lg"),a.on(n.bodyRendered,(function(){a.find("#esr-blockname").val(s.blockname),a.find("#esr-region").val(s.region),a.find("#esr-sesskey").val(s.sesskey),u=_(s,o)})),a.on(n.hidden,(function(){o.destroy()})),function(o,a,n){a.on("click","#scheduletab .dropdown a.dropdown-item",(function(){var t,o,a,n;o=e(t=this).data("value"),a=e(t).text(),(n=e(t).closest(".dropdown").find("button.dropdown-toggle")).text(a),n.data("value",o)})),a.on("click","#scheduletab .dropdown.duration-dropdown a.dropdown-item",(function(){!function(t,o){var a=e(t).data("value");e(t).text();o.find("#scheduletab input#esr-sendduration").val(a),e("#scheduletab .dropdown:not(.duration-dropdown) button.dropdown-toggle").hide();var n=null;switch(a){case 1:n=e("#scheduletab .dropdown.weekly-dropdown button.dropdown-toggle");break;case 2:n=e("#scheduletab .dropdown.monthly-dropdown button.dropdown-toggle");break;default:n=e("#scheduletab .dropdown.daily-dropdown button.dropdown-toggle")}n.show();var i=n.data("value");e(p).val(i)}(this,a)})),a.on("click","#scheduletab .dropdown:not(.duration-dropdown) a.dropdown-item",(function(){a.find(p).val(e(this).data("value"))})),a.on("click","#listemailstab .esr-email-sched-setting",(function(){!function(t,o){var a=e(t).data("id"),n=e(t).data("blockname"),i=e(t).data("region");e.ajax({url:l.requestUrl,type:l.requestType,sesskey:e(t).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:e(t).data("sesskey"),data:JSON.stringify({id:a,blockname:n,region:i})}}).done((function(t){(t=JSON.parse(t)).error?console.log(t):(!function(t,o,a){var n=null,i=null;e.each(t.data,(function(t,o){if("object"==typeof o)a.find("#esr-blockname").val(o.blockname),a.find("#esr-region").val(o.region);else if("esrduration"===t){var r='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+o+'"]';n=o,a.find(r).click()}else if("esrtime"===t)i=o;else if("esremailenable"===t){var l=e('input[name="'+t+'"]');o?l.prop("checked",!0):l.prop("checked",!1)}else e('[name="'+t+'"]').val(o)}));var r='.dropdown-item[data-value="'+i+'"]',l=null;switch(n){case"1":l=e(".weekly-dropdown");break;case"2":l=e(".monthly-dropdown");break;default:l=e(".daily-dropdown")}l.find(r).click()}(t,0,o),o.find('[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane').removeClass("active show"),o.find('[aria-controls="scheduletab"], #scheduletab').addClass("active show"))})).fail((function(e){console.log(e)}))}(this,a)})),a.on("click","#listemailstab .esr-email-sched-delete",(function(i){o.id=e(this).data("id"),r.get_strings([{key:"confirmemailremovaltitle",component:"local_edwiserreports"},{key:"confirmemailremovalquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done((function(r){t.confirm(r[0],r[1],r[2],r[3],e.proxy((function(){!function(t,o,a){var n=t.id,i=t.block,r=t.region,s=o.find(".esr-form-error");s.html(k).show(),console.log(t),e.ajax({url:l.requestUrl,type:l.requestType,sesskey:t.sesskey,data:{action:"delete_scheduled_email_ajax",sesskey:t.sesskey,data:JSON.stringify({id:n,blockname:i,region:r})}}).done((function(e){e.error?s.html(b):(u&&u.destroy(),u=_(t,a),s.html(h))})).fail((function(e){s.html(b),console.log(e)})).always((function(){s.delay(3e3).fadeOut("slow")}))}(o,a,n)}),i.currentTarget))}))})),a.on("change","#listemailstab [id^='esr-toggle-']",(function(){o.id=e(this).data("id"),function(t,o,a){var n=t.id,i=t.block,r=t.region,s=t.sesskey,d=o.find(".esr-form-error");e.ajax({url:l.requestUrl,type:l.requestType,data:{action:"change_scheduled_email_status_ajax",sesskey:s,data:JSON.stringify({id:n,blockname:i,region:r})}}).done((function(e){e=JSON.parse(e),console.log(e),e.error?(d.html(e.errormsg),d.show(),d.delay(3e3).fadeOut("slow")):(d.html(e.successmsg),d.show(),d.delay(3e3).fadeOut("slow"))}))}(o,a)})),a.on("click",'[data-action="send"]',(function(){!function(t,o,a){var n=t.filter,i=t.cohortid,r=t.block,l=a.find(".esr-form-error");l.html("").show(),e(document).find("#cover-spin")&&e("body").append('<div id="cover-spin"></div>');e(document).find("#cover-spin").show(0),e.ajax({url:M.cfg.wwwroot+"/local/edwiserreports/download.php?type=email&filter="+n+"&cohortid="+i+"&block="+r,type:"POST",data:a.find("form").serialize()}).done((function(t){(t=e.parseJSON(t)).error?l.html('<div class="alert alert-danger"><b>ERROR:</b>'+t.errormsg+"</div>"):l.html('<div class="alert alert-success"><b>Success:</b>'+t.errormsg+"</div>")})).fail((function(){l.html('<div class="alert alert-danger"><b>ERROR:</b>'+response.errormsg+"</div>")})).always((function(){l.delay(3e3).fadeOut("slow"),e(document).find("#cover-spin").hide()}))}(o,0,a)})),function(t,o,a){o.on("click",'[data-action="save"]',(function(){var n=o.find(".esr-form-error");if(n.html(k).show(),function(e,t){var o=e.find('[name="esrname"]').val(),a=e.find('[name="esrrecepient"]').val();if(""==o||""==a)return t.html(v).show(),!1;if(!/^(\s?[^\s,]+@[^\s,]+\.[^\s,]+\s?,)*(\s?[^\s,]+@[^\s,]+\.[^\s,]+)$/g.test(a))return t.html(y).show(),!1;return!0}(o.find("form"),n)){var i=t.filter,r=t.cohortid,l=t.block,s=M.cfg.wwwroot+"/local/edwiserreports/download.php?type=emailscheduled&filter="+i+"&cohortid="+r+"&block="+l;e.ajax({url:s,type:"POST",data:o.find("form").serialize()}).done((function(o){(o=e.parseJSON(o)).error?(n.html(m),console.log(o.error)):(u&&u.destroy(),u=_(t,a),n.html(g))})).fail((function(e){n.html(m),console.log(e)})).always((function(){n.delay(3e3).fadeOut("slow")}))}})),o.on("click",'[data-action="cancel"]',(function(){o.find('[name^=esr]:not(.d-none):not([id="esr-toggle-"])').val(""),o.find("#esr-id").val(-1)}))}(o,a,n)}(s,a,o),o.show()}))})),e("#wdm-edwiserreports").removeClass("d-none"),e(document).on("click",s.blockSettingsBtn,(function(i){i.preventDefault();var r=e(i.currentTarget).data("contextid"),s=e(i.currentTarget).data("blockname"),d=e(i.currentTarget).data("action");if("edit"==d)a.create({title:"Edit Block Setting",body:o.loadFragment("local_edwiserreports","get_blocksetting_form",r,{blockname:s})}).done((function(o){var a=o.getRoot();o.modal.addClass("modal-dialog-centered"),a.on(n.bodyRendered,(function(){var a=o.modal.find(".block-settings-form");o.modal.find(".save-block-settings").on("click",(function(o){o.preventDefault();var n=a.serializeArray(),i={};e(n).each((function(e,t){i[t.name]=t.value})),function(o,a,n){a.blockname=o,a=JSON.stringify(a);var i=e("#"+o).data("sesskey");e.ajax({url:l.requestUrl,type:"GET",data:{action:"set_block_preferences_ajax",sesskey:i,data:a}}).done((function(e){})).fail((function(e){console.log(e),t.addNotification({message:e,type:"error"})})).always((function(){location.reload()}))}(s,i)}))})),a.on(n.hidden,(function(){o.destroy()})),o.show()}));else if("hide"==d){var c=e(this).data("hidden"),u=e(this);e.ajax({url:l.requestUrl,type:"GET",data:{action:"toggle_hide_block_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({blockname:s,hidden:c})}}).done((function(e){(e=JSON.parse(e)).success&&(c?(u.closest(".edwiserReport-block").removeClass("block-hidden"),u.data("hidden",0),u.html(M.util.get_string("hide","local_edwiserreports"))):(u.closest(".edwiserReport-block").addClass("block-hidden"),u.data("hidden",1),u.html(M.util.get_string("unhide","local_edwiserreports"))))})).fail((function(e){})).always((function(){}))}else"editcap"==d&&a.create({title:"Edit Block Capabilities",body:o.loadFragment("local_edwiserreports","get_blockscap_form",r,{blockname:s})}).done((function(a){var i=a.getRoot();a.modal.addClass("modal-dialog-centered modal-lg"),i.on(n.bodyRendered,(function(){var n=a.modal.find(".block-cap-form");a.modal.find("#menucapabilities").on("change",(function(t){t.preventDefault();var i=n.serializeArray(),l={};e(i).each((function(e,t){l[t.name]=t.value})),o.loadFragment("local_edwiserreports","block_overview_display",r,{capvalue:l.capabilities}).done((function(e,t,o){a.modal.find(".cap-overview").html(e),w(a)}))})),w(a),n=a.modal.find(".block-cap-form"),a.modal.find(".save-block-caps").on("click",(function(o){o.preventDefault();var i=n.serializeArray(),r={};e(i).each((function(e,t){r[t.name]=t.value})),function(o,a,n){a.blockname=o,a=JSON.stringify(a);var i=e("#"+o).data("sesskey");e.ajax({url:l.requestUrl,type:"GET",data:{action:"set_block_capability_ajax",sesskey:i,data:a}}).done((function(e){(e=JSON.parse(e)).success?(n(),location.reload()):t.addNotification({message:"Error",type:"error"})})).fail((function(e){console.log(e),t.addNotification({message:e,type:"error"})})).always((function(){n(),location.reload()}))}(s,r,(function(){a.destroy()}))}))})),i.on(n.hidden,(function(){a.destroy()})),a.show()}))})),function(t){var o='<div id="editing-btn" class="d-flex flex-wrap">';o+='<div class="ml-auto d-flex">',t?(t=0,editingtxt="Stop Customising this page",o+='<div class="singlebutton">',o+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',o+='<input type="hidden" name="reset" value="1">',o+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',o+='<button type="submit" class="btn btn-secondary" title="">Reset Page to Default</button>',o+="</form>",o+="</div>"):(t=1,editingtxt="Customise this page");o+='<div class="singlebutton">',o+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',o+='<input type="hidden" name="edit" value="'+t+'">',o+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',o+='<button type="submit" class="btn btn-secondary" title="">'+editingtxt+"</button>",o+="</form>",o+="</div>",o+="</div></div>",e("#page-local-edwiserreports-index #page-header .card-body").append(o)}(e("#wdm-edwiserreports").data("editing"))})),{loader:k}}));
